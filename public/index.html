<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo & Video Upload</title>
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Ponomar&family=Scope+One&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #ebe6d6;
      font-family: "Scope One", serif;
      font-size: large;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      text-align: center;
      height: 100vh;
      margin: 0;
    }
    .form-heading-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 40vw;
      margin-top: 5vh;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }
    .form-entry-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 40vw;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    .form-title {
      font-family: "Great Vibes", cursive;
      font-size: xxx-large;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 200;
    }
    .instruct {
      font-family: "Ponomar", sans-serif;
      font-size: x-large;
      width: 100%;
      font-weight: 300;
    }
    .file-list-display {
      background-color: white;
      border: none;
      padding: 10px;
      font-family: "Scope One", serif;
      white-space: pre-wrap;
      text-align: center;
      width: 40vw;
      margin: auto;
      margin-top: 1vh;
      display: none;
    }
    .hidden {
      display: none;
    }
    .error-text {
      color: red;
      display: none;
    }
    .styled-upload-button {
      width: 25%;
      background-color: #6378ff;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: medium;
      cursor: pointer;
      margin-top: 15px;
      margin-right: 15px;
      margin-bottom: 30px;
      display: inline-block;
      text-align: center;
      font-family: "Scope One", serif;
      font-weight: 700;
    }
    .styled-upload-button:hover {
      background-color: #5751d1;
    }
    .styled-upload-button:active {
      background-color: #3a4ec9;
    }
    button {
      width: 20%;
      background-color: #6378ff;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: medium;
      cursor: pointer;
      margin-top: 15px;
      margin-right: 15px;
      margin-bottom: 30px;
      font-family: "Scope One", serif;
      font-weight: 700;
    }
    button:hover {
      background-color: #5751d1;
    }
    button:active {
      background-color: #3a4ec9;
    }
    .progress-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
      background: white;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 0 3px #aaa;
    }
    .progress-thumb {
      display: flex;
      align-items: center;
      width: 100%;
    }
    .thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 10px;
    }
    .progress-bar {
      background-color: #4caf50;
      height: 20px;
      color: white;
      padding: 2px 10px;
      border-radius: 4px;
      width: 0%;
      transition: width 0.2s;
    }
  </style>
</head>
<body>
  <div class="form-heading-container">
    <h1 class="form-title">Share Your Memories</h1>
    <p>We would love to see all of your favorite moments, so please feel free to upload as many images or videos as you'd like.</p>
    <p>Thank you!</p>
  </div>

  <div class="form-entry-container">
    <h2 class="instruct">Upload Files</h2>
    <input type="hidden" id="authKey" name="authKey" value="{{authKey}}" />

    <label for="fileUpload" class="styled-upload-button">Select File(s)</label>
    <input type="file" id="fileUpload" name="files" accept="image/*,video/*" multiple style="display: none;" />

    <div id="uploadList"></div>
    <button type="button" id="uploadButton">Start Upload</button>
    <button type="button" id="pauseButton" class="styled-upload-button" style="display: none;">Pause</button>
    <button type="button" id="resumeButton" class="styled-upload-button" style="display: none;">Resume</button>
  </div>

<script type="module">
  import { prepareChunks } from './public/chunked-upload.js';

  const MAX_WORKERS = 4;
  const fileInput = document.getElementById("fileUpload");
  const uploadButton = document.getElementById("uploadButton");
  const pauseButton = document.getElementById("pauseButton");
  const resumeButton = document.getElementById("resumeButton");
  const uploadList = document.getElementById("uploadList");
  const authKey = document.getElementById("authKey")?.value.trim();

  let uploadQueue = [];
  let paused = false;
  
  fileInput.addEventListener("change", async () => {
    const files = [...fileInput.files];
    uploadList.innerHTML = "";
    const { chunks, manifest } = await prepareChunks(files);
    const id = manifest.sha256;
    uploadQueue = [{ id, file: files[0], chunks, manifest, uploaded: new Set() }];

    for (const task of uploadQueue) {
      const entry = document.createElement("div");
      entry.classList.add("progress-container");
      entry.innerHTML = `
        <div class="progress-thumb">
          <img src="" class="thumb" alt="" />
          <div class="progress-bar" id="bar-${task.id}">Waiting...</div>
        </div>
      `;
      uploadList.appendChild(entry);
    }
  });

  uploadButton.addEventListener("click", async () => {
    if (!authKey || uploadQueue.length === 0) return;
    paused = false;
    uploadButton.disabled = true;
    uploadButton.style.display = "none";
    [pauseButton, resumeButton].forEach(button => {
      button.style.display = "block";
    });

    const pool = Array(MAX_WORKERS).fill(null);
    let nextIndex = 0;

    async function worker() {
      while (nextIndex < uploadQueue.length) {
        if (paused) return;
        const task = uploadQueue[nextIndex++];
        const bar = document.getElementById(`bar-${task.id}`);
        const status = await fetch(`/upload-status?hash=${task.manifest.sha256}`).then(r => r.json());
        const received = new Set(status.received || []);

        for (let j = 0; j < task.chunks.length; j++) {
          if (paused) return;
          if (received.has(j)) continue;

          const formData = new FormData();
          formData.append("authKey", authKey);
          formData.append("fileHash", task.manifest.sha256);
          formData.append("chunkIndex", j);
          formData.append("totalChunks", task.chunks.length);
          formData.append("originalName", task.file.name);
          formData.append("isVideo", task.file.type.startsWith("video") ? "true" : "false");
          formData.append("chunk", task.chunks[j]);

          let retries = 0;
          while (retries < 3) {
            try {
              const res = await fetch("/upload-chunk", { method: "POST", body: formData });
              if (!res.ok) throw new Error("Chunk upload failed");
              break;
            } catch (e) {
              retries++;
            }
          }

          const percent = Math.round(((j + 1 + received.size) / task.chunks.length) * 100);
          bar.style.width = `${percent}%`;
          bar.textContent = `${task.file.name} â€” ${percent}%`;
        }
      }
    }

    await Promise.all(pool.map(() => worker()));
    uploadButton.disabled = false;
    if (!paused)
    {
      uploadButton.style.display = "block";
      [pauseButton,resumeButton].forEach(button => {
        button.style.display = "none";
      });
    }
  });

  pauseButton.addEventListener("click", () => {
    paused = true;
  });

  resumeButton.addEventListener("click", () => {
    if (paused) uploadButton.click();
  });
</script>
</body>
</html>
